\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, amsthm, amssymb}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{geometry}
\geometry{margin=1in}

% Define colors for Lean syntax highlighting
\definecolor{leanKeyword}{RGB}{0, 0, 255}       % Blue for keywords
\definecolor{leanType}{RGB}{139, 0, 139}        % Dark magenta for types
\definecolor{leanString}{RGB}{0, 128, 0}        % Green for strings
\definecolor{leanComment}{RGB}{128, 128, 128}   % Gray for comments
\definecolor{leanDefinition}{RGB}{255, 140, 0}  % Dark orange for definitions
\definecolor{leanAttribute}{RGB}{255, 20, 147}  % Deep pink for attributes
\definecolor{leanBackground}{RGB}{250, 250, 250} % Light gray background

% Define Lean language for listings
\lstdefinelanguage{Lean}{
  % Keywords
  morekeywords=[1]{def, theorem, lemma, instance, class, structure, inductive,
    axiom, constant, variable, namespace, section, noncomputable, protected,
    private, abbrev, example, open, attribute, local, mutual, by, where,
    extends, deriving, end, import, prelude, theory, with, without, using,
    match, if, then, else, fun, have, show, from, let, in, do, begin, calc},
  % Types and Type constructors
  morekeywords=[2]{Type, Prop, Sort, Nat, Int, Bool, String, Char, List,
    Option, Unit, Prod, Sum, Sigma, Subtype, Set, Scheme, CommRingCat,
    AffineScheme, Opens, IsAffine, IsAffineOpen, Spec, Category, Functor,
    Iso, IsIso, CompactSpace, IsCompact, IsOpenImmersion, Equiv, Hom,
    IrreducibleSpace, IsIntegral, Field, IsFractionRing, IsDomain},
  % Tactics (if they appear)
  morekeywords=[3]{simp, rfl, exact, apply, intro, cases, induction, refl,
    constructor, assumption, contradiction, trivial, sorry, admit, rw,
    convert, infer_instance, ext, rintro, obtain, refine, dsimp},
  % Sensitive
  sensitive=true,
  % Comments
  morecomment=[l]{--},
  morecomment=[n]{/-}{-/},
  % Strings
  morestring=[b]",
  % Style
  keywordstyle=[1]\color{leanKeyword}\bfseries,
  keywordstyle=[2]\color{leanType}\bfseries,
  keywordstyle=[3]\color{leanDefinition}\itshape,
  commentstyle=\color{leanComment}\itshape,
  stringstyle=\color{leanString},
  % Highlight attributes
  moredelim=[is][\color{leanAttribute}]{@[}{]},
  moredelim=[is][\color{leanAttribute}]{\#[}{]},
}

\lstset{
  language=Lean,
  basicstyle=\ttfamily\small,
  backgroundcolor=\color{leanBackground},
  breaklines=true,
  frame=single,
  framerule=0.5pt,
  rulecolor=\color{gray!30},
  numbers=left,
  numberstyle=\tiny\color{gray},
  numbersep=5pt,
  showstringspaces=false,
  captionpos=b,
  xleftmargin=10pt,
  framexleftmargin=10pt,
  % Unicode replacements for mathematical symbols
  literate={Œì}{{$\Gamma$}}1
           {‚ä§}{{$\top$}}1
           {‚ü∂}{{$\to$}}2
           {‚âÖ}{{$\cong$}}1
           {‚äÜ}{{$\subseteq$}}1
           {‚®Ü}{{$\bigsqcup$}}1
           {‚àà}{{$\in$}}1
           {‚àÉ}{{$\exists$}}1
           {‚àß}{{$\land$}}1
           {‚Åª¬π·µÅ}{{$^{-1}U$}}3
           {‚Åª¬π}{{$^{-1}$}}2
           {‚â´}{{>>}}1
           {‚â§}{{$\leq$}}1
           {·µí·µñ}{{$^{op}$}}2
           {‚•§}{{$\Rightarrow$}}2
           {‚âå}{{$\simeq$}}1
           {‚ãô}{{$\ggg$}}1
           {‚àÄ}{{$\forall$}}1
           {‚Üë}{{$\uparrow$}}1
           {ùí∞}{{$\mathcal{U}$}}1
           {ùüô}{{$\mathbb{1}$}}1
           {''·µÅ}{{''U}}2
           {‚â™‚â´}{{$\ll\gg$}}2
           {Œπ}{{$\iota$}}1
           {‚Üí}{{$\to$}}1
           {·µÅ}{{U}}1
           {:=}{{$\mathrel{:=}$}}2
           {√ó}{{$\times$}}1
           {‚ß∏}{{$/\!/$}}1
           {‚Üî}{{$\leftrightarrow$}}1
           {‚ü®}{{$\langle$}}1
           {‚ü©}{{$\rangle$}}1
           {Œ±}{{$\alpha$}}1
           {Œ≤}{{$\beta$}}1
           {Œ≥}{{$\gamma$}}1
           {Œ¥}{{$\delta$}}1
           {Œµ}{{$\varepsilon$}}1
           {Œª}{{$\lambda$}}1
           {Œº}{{$\mu$}}1
           {œÉ}{{$\sigma$}}1
           {œÑ}{{$\tau$}}1
           {œÜ}{{$\varphi$}}1
           {œà}{{$\psi$}}1
           {œâ}{{$\omega$}}1
           {‚àû}{{$\infty$}}1
           {‚àÇ}{{$\partial$}}1
           {‚àá}{{$\nabla$}}1
           {‚§≥}{{$\leadsto$}}1
}

\theoremstyle{definition}
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{instance}{Instance}

\title{Function Fields of Integral Schemes in Mathlib4\\
\large A Companion to \texttt{FunctionField.lean}}
\author{}
\date{}

\begin{document}
\maketitle

\section{Introduction}

This document provides a natural language companion to the \texttt{FunctionField.lean} file in Mathlib4. The file develops the theory of function fields for integral schemes, which is one of the most fundamental concepts in algebraic geometry. The function field captures the "generic" behavior of rational functions on an irreducible variety and serves as the algebraic counterpart to the geometric notion of the generic point.

In classical algebraic geometry, the function field of an irreducible variety is the field of rational functions on that variety. In scheme theory, this becomes the stalk of the structure sheaf at the generic point of an irreducible scheme. This generalization provides a powerful tool for understanding the global properties of schemes through local algebraic data.

\section{The Function Field}

\subsection{Definition}

\begin{lstlisting}
noncomputable abbrev Scheme.functionField [IrreducibleSpace X] : CommRingCat :=
  X.presheaf.stalk (genericPoint X)
\end{lstlisting}

\textbf{Mathematical Significance:} The function field of an irreducible scheme $X$ is defined as the stalk of the structure sheaf at the generic point of $X$. Despite the name, this is only a field when the scheme is integral (both irreducible and reduced).

The generic point represents the "most general" point of the scheme - it specializes to every other point. Therefore, the stalk at the generic point captures the most general algebraic behavior of the scheme and contains the minimal amount of algebraic information needed to understand the entire scheme.

In classical terms, if $X = \mathrm{Spec}(R)$ where $R$ is an integral domain, then the function field is the field of fractions of $R$, which consists of all formal quotients $\frac{f}{g}$ where $f, g \in R$ and $g \neq 0$.

\subsection{Canonical Germ Maps}

\begin{lstlisting}
noncomputable abbrev Scheme.germToFunctionField [IrreducibleSpace X] (U : X.Opens)
    [h : Nonempty U] : Œì(X, U) ‚ü∂ X.functionField :=
  X.presheaf.germ U
    (genericPoint X)
      (((genericPoint_spec X).mem_open_set_iff U.isOpen).mpr (by simpa using h))
\end{lstlisting}

\textbf{Mathematical Significance:} For any nonempty open subset $U$ of an irreducible scheme $X$, there is a canonical ring homomorphism from the sections over $U$ to the function field. This map sends each section to its "germ" or "value" at the generic point.

This construction establishes the function field as the "limit" of all the section rings as we take smaller and smaller (but still nonempty) open sets. Since the generic point lies in every nonempty open set of an irreducible scheme, we always have such a canonical map.

\section{Field Structure for Integral Schemes}

\subsection{Field Instance}

\begin{lstlisting}
noncomputable instance [IsIntegral X] : Field X.functionField := by
  refine .ofIsUnitOrEqZero fun a ‚Ü¶ ?_
  obtain ‚ü®U, m, s, rfl‚ü© := TopCat.Presheaf.germ_exist _ _ a
  rw [or_iff_not_imp_right, ‚Üê (X.presheaf.germ _ _ m).hom.map_zero]
  intro ha
  replace ha := ne_of_apply_ne _ ha
  have hs : genericPoint X ‚àà RingedSpace.basicOpen _ s := by
    rw [‚Üê SetLike.mem_coe, (genericPoint_spec X).mem_open_set_iff,
      Set.univ_inter, Set.nonempty_iff_ne_empty, Ne, ‚Üê Opens.coe_bot, ‚Üê SetLike.ext'_iff]
    ¬∑ erw [basicOpen_eq_bot_iff]
      exact ha
    ¬∑ exact (RingedSpace.basicOpen _ _).isOpen
  have := (X.presheaf.germ _ _ hs).hom.isUnit_map (RingedSpace.isUnit_res_basicOpen _ s)
  rwa [Presheaf.germ_res_apply] at this
\end{lstlisting}

\textbf{Mathematical Significance:} When the scheme is integral (irreducible and reduced), the function field is indeed a field. The proof shows that every nonzero element has an inverse by using the fundamental property that in integral schemes, a section that doesn't vanish identically must be invertible on some basic open set, and since the generic point lies in every nonempty open, it lies in this basic open where the section is invertible.

This result establishes the crucial connection between the geometric notion of integrality and the algebraic notion of being a field. It shows that integral schemes have well-defined function fields that capture their rational function behavior.

\section{Injectivity Properties}

\subsection{Germ Injectivity}

\begin{lstlisting}
theorem germ_injective_of_isIntegral [IsIntegral X] {U : X.Opens} (x : X) (hx : x ‚àà U) :
    Function.Injective (X.presheaf.germ U x hx) := by
  rw [injective_iff_map_eq_zero]
  intro y hy
  rw [‚Üê (X.presheaf.germ U x hx).hom.map_zero] at hy
  obtain ‚ü®W, hW, iU, iV, e‚ü© := X.presheaf.germ_eq _ hx hx _ _ hy
  cases Subsingleton.elim iU iV
  haveI : Nonempty W := ‚ü®‚ü®_, hW‚ü©‚ü©
  exact map_injective_of_isIntegral X iU e
\end{lstlisting}

\textbf{Mathematical Significance:} In an integral scheme, the germ map from any open set to any stalk is injective. This fundamental result shows that in integral schemes, sections can be uniquely recovered from their germs, reflecting the fact that integral domains embed into their fields of fractions.

\subsection{Function Field Map Injectivity}

\begin{lstlisting}
theorem Scheme.germToFunctionField_injective [IsIntegral X] (U : X.Opens) [Nonempty U] :
    Function.Injective (X.germToFunctionField U) :=
  germ_injective_of_isIntegral _ _ _
\end{lstlisting}

\textbf{Mathematical Significance:} The canonical map from sections over any nonempty open set to the function field is injective for integral schemes. This means that the function field contains a faithful copy of all the section rings, making it a universal repository for the rational functions on the scheme.

\section{Behavior Under Morphisms}

\subsection{Generic Points and Open Immersions}

\begin{lstlisting}
theorem genericPoint_eq_of_isOpenImmersion {X Y : Scheme} (f : X ‚ü∂ Y) [H : IsOpenImmersion f]
    [hX : IrreducibleSpace X] [IrreducibleSpace Y] :
    f.base (genericPoint X) = genericPoint Y := by
  apply ((genericPoint_spec Y).eq _).symm
  convert (genericPoint_spec X).image (show Continuous f.base by fun_prop)
  symm
  rw [‚Üê Set.univ_subset_iff]
  convert subset_closure_inter_of_isPreirreducible_of_isOpen _ H.base_open.isOpen_range _
\end{lstlisting}

\textbf{Mathematical Significance:} When we have an open immersion between irreducible schemes, the generic point of the source maps to the generic point of the target. This fundamental result ensures that open subschemes of irreducible schemes have the "same" generic point, preserving the function field structure.

This property is crucial for understanding how function fields behave under geometric inclusions and ensures that rational functions on a scheme can be naturally extended to any larger scheme containing it as an open subscheme.

\section{Affine Case}

\subsection{Generic Point in Spectra}

\begin{lstlisting}
@[simp]
theorem genericPoint_eq_bot_of_affine (R : CommRingCat) [IsDomain R] :
    genericPoint (Spec R) = (‚ä• : PrimeSpectrum R) := by
  apply (genericPoint_spec (Spec R)).eq
  rw [isGenericPoint_def]
  rw [‚Üê PrimeSpectrum.zeroLocus_vanishingIdeal_eq_closure, PrimeSpectrum.vanishingIdeal_singleton]
  rw [‚Üê PrimeSpectrum.zeroLocus_singleton_zero]
  rfl
\end{lstlisting}

\textbf{Mathematical Significance:} For the spectrum of an integral domain $R$, the generic point is the zero ideal $(0)$, which corresponds to the smallest prime ideal. This makes algebraic sense because the zero ideal represents the "most general" prime, and localizing at it gives the field of fractions.

\subsection{Fraction Ring Structure}

\begin{lstlisting}
instance functionField_isFractionRing_of_affine (R : CommRingCat.{u}) [IsDomain R] :
    IsFractionRing R (Spec R).functionField := by
  convert StructureSheaf.IsLocalization.to_stalk R (genericPoint (Spec R))
  delta IsFractionRing IsLocalization.AtPrime
  -- Porting note: `congr` does not work for `Iff`
  apply Eq.to_iff
  congr 1
  rw [genericPoint_eq_bot_of_affine]
  ext
  exact mem_nonZeroDivisors_iff_ne_zero
\end{lstlisting}

\textbf{Mathematical Significance:} For an affine integral scheme $\mathrm{Spec}(R)$ where $R$ is an integral domain, the function field is precisely the field of fractions of $R$. This establishes the fundamental dictionary between algebraic and geometric notions of function fields.

This result connects the abstract scheme-theoretic definition with the classical algebraic notion, showing that our geometric construction recovers the familiar algebraic object in the affine case.

\section{Local Properties}

\subsection{Fraction Ring Property for Affine Opens}

\begin{lstlisting}
theorem functionField_isFractionRing_of_isAffineOpen [IsIntegral X] (U : X.Opens)
    (hU : IsAffineOpen U) [Nonempty U] :
    IsFractionRing Œì(X, U) X.functionField := by
  haveI : IsAffine _ := hU
  haveI : IsIntegral U :=
    @isIntegral_of_isAffine_of_isDomain _ _ _
      (by rw [Scheme.Opens.toScheme_presheaf_obj, Opens.isOpenEmbedding_obj_top]; infer_instance)
  delta IsFractionRing Scheme.functionField
  convert hU.isLocalization_stalk ‚ü®genericPoint X,
    (((genericPoint_spec X).mem_open_set_iff U.isOpen).mpr (by simpa using ‚ÄπNonempty U‚Ä∫))‚ü© using 1
\end{lstlisting}

\textbf{Mathematical Significance:} For any nonempty affine open subset $U$ of an integral scheme $X$, the function field of $X$ is the field of fractions of $\Gamma(X, U)$. This shows that the function field can be constructed from the sections over any sufficiently large affine open set.

This result provides a practical way to compute function fields and shows that they have a local nature - they can be understood by examining sufficiently large affine pieces of the scheme.

\subsection{Stalk-Function Field Relationship}

\begin{lstlisting}
instance [IsIntegral X] (x : X) :
    IsFractionRing (X.presheaf.stalk x) X.functionField :=
  let U : X.Opens := (X.affineCover.map x).opensRange
  have hU : IsAffineOpen U := isAffineOpen_opensRange (X.affineCover.map x)
  let x : U := ‚ü®x, X.affineCover.covers x‚ü©
  have : Nonempty U := ‚ü®x‚ü©
  -- Technical proof involving localizations
\end{lstlisting}

\textbf{Mathematical Significance:} For any point $x$ in an integral scheme $X$, the function field is the field of fractions of the stalk at $x$. This establishes a fundamental relationship between local and global properties of integral schemes.

This result shows that every stalk naturally embeds into the function field, and the function field can be constructed as the field of fractions of any stalk. This provides multiple equivalent ways to think about and construct function fields.

\section{Domain Properties}

\subsection{Stalks as Integral Domains}

\begin{lstlisting}
instance [IsIntegral X] {x : X} : IsDomain (X.presheaf.stalk x) :=
  Function.Injective.isDomain _ (IsFractionRing.injective (X.presheaf.stalk x) (X.functionField))
\end{lstlisting}

\textbf{Mathematical Significance:} In an integral scheme, every stalk is an integral domain. This follows from the fact that each stalk embeds into the function field (which is a field), and subrings of fields are integral domains.

This result provides a local characterization of integrality and shows that the global geometric property of being integral translates directly to local algebraic properties at every point.

\section{Geometric Significance}

The function field theory developed in this file captures several fundamental aspects of algebraic geometry:

\begin{itemize}
\item \textbf{Rational Functions}: The function field provides the scheme-theoretic generalization of the field of rational functions on an algebraic variety. It captures the "generic" algebraic behavior of the scheme.

\item \textbf{Generic Point Philosophy}: By defining the function field as the stalk at the generic point, the theory makes precise the intuitive idea that generic behavior determines specific behavior in algebraic geometry.

\item \textbf{Local-Global Principle}: The various characterizations (via affine opens, stalks, etc.) show that global function fields can be understood through local algebraic data.

\item \textbf{Birational Invariance}: The function field captures the birational geometry of schemes - schemes that are birationally equivalent have isomorphic function fields.

\item \textbf{Integrality Detection}: The field property of function fields provides a way to detect and characterize integral schemes through their most generic algebraic data.
\end{itemize}

The function field serves as a bridge between the geometric intuition of "rational functions defined everywhere except on lower-dimensional sets" and the algebraic precision required for modern algebraic geometry. It provides the foundation for many advanced topics including birational geometry, function field arithmetic, and the study of rational points on schemes.

\end{document}